"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[52858],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return d}});var a=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=p(n),d=i,h=u["".concat(s,".").concat(d)]||u[d]||m[d]||r;return n?a.createElement(h,o(o({ref:t},c),{},{components:n})):a.createElement(h,o({ref:t},c))}));function d(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:i,o[1]=l;for(var p=2;p<r;p++)o[p]=n[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},57190:function(e,t,n){n.r(t),n.d(t,{assets:function(){return c},contentTitle:function(){return s},default:function(){return d},frontMatter:function(){return l},metadata:function(){return p},toc:function(){return m}});var a=n(87462),i=n(63366),r=(n(67294),n(3905)),o=["components"],l={id:"replication",title:"How to set up replication on a small cluster?",sidebar_label:"Set up replication"},s=void 0,p={unversionedId:"how-to-guides/replication",id:"version-2.3.0/how-to-guides/replication",title:"How to set up replication on a small cluster?",description:"[![Related - Reference",source:"@site/memgraph_versioned_docs/version-2.3.0/how-to-guides/replication.md",sourceDirName:"how-to-guides",slug:"/how-to-guides/replication",permalink:"/docs/memgraph/how-to-guides/replication",editUrl:"https://github.com/memgraph/docs/tree/master/memgraph_versioned_docs/version-2.3.0/how-to-guides/replication.md",tags:[],version:"2.3.0",frontMatter:{id:"replication",title:"How to set up replication on a small cluster?",sidebar_label:"Set up replication"},sidebar:"memgraph",previous:{title:"Use query modules",permalink:"/docs/memgraph/how-to-guides/query-modules"},next:{title:"Triggers",permalink:"/docs/memgraph/reference-guide/triggers"}},c={},m=[{value:"Cluster topology",id:"cluster-topology",level:2},{value:"How to run multiple instances?",id:"how-to-run-multiple-instances",level:2},{value:"How to demote an instance to a REPLICA role?",id:"how-to-demote-an-instance-to-a-replica-role",level:2},{value:"How to register REPLICA instances?",id:"how-to-register-replica-instances",level:2},{value:"How to check info about registered REPLICA instances?",id:"how-to-check-info-about-registered-replica-instances",level:2},{value:"How to drop a REPLICA instance?",id:"how-to-drop-a-replica-instance",level:2},{value:"How to promote a REPLICA instance to MAIN?",id:"how-to-promote-a-replica-instance-to-main",level:2}],u={toc:m};function d(e){var t=e.components,n=(0,i.Z)(e,o);return(0,r.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"/docs/memgraph/reference-guide/replication"},(0,r.kt)("img",{parentName:"a",src:"https://img.shields.io/static/v1?label=Related&message=Reference%20Guide&color=yellow&style=for-the-badge",alt:"Related - Reference\nGuide"})),"\n",(0,r.kt)("a",{parentName:"p",href:"/docs/memgraph/under-the-hood/replication"},(0,r.kt)("img",{parentName:"a",src:"https://img.shields.io/static/v1?label=Related&message=Under%20the%20hood&color=orange&style=for-the-badge",alt:"Related - Under the\nHood"})),"\n",(0,r.kt)("a",{parentName:"p",href:"https://memgraph.com/blog/implementing-data-replication"},(0,r.kt)("img",{parentName:"a",src:"https://img.shields.io/static/v1?label=Related&message=Blog%20post&color=9C59DB&style=for-the-badge",alt:"Related - Blog\nPost"}))),(0,r.kt)("p",null,"In the replication process, the data is replicated from one storage (MAIN\ninstance) to another (REPLICA instances), thus providing a combination of\nconsistency, availability and partition tolerance when distributing data over\nseveral instances."),(0,r.kt)("p",null,"This example demonstrates how to create a simple cluster of nodes running\nMemgraph instances, and set up replication using various replication modes."),(0,r.kt)("h2",{id:"cluster-topology"},"Cluster topology"),(0,r.kt)("p",null,"The cluster will consist of four nodes, one MAIN instance and three REPLICA\ninstances. In order to showcase the creation of REPLICA instances with different\nreplication modes, we will create:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The MAIN instance - contains the original data that will be replicated to\nREPLICA instances"),(0,r.kt)("li",{parentName:"ul"},"REPLICA instance 1 - replication in the SYNC mode"),(0,r.kt)("li",{parentName:"ul"},"REPLICA instance 2 - replication in the SYNC WITH TIMEOUT mode"),(0,r.kt)("li",{parentName:"ul"},"REPLICA instance 3 - replication in the ASYNC mode")),(0,r.kt)("h2",{id:"how-to-run-multiple-instances"},"How to run multiple instances?"),(0,r.kt)("p",null,"If you are running multiple instances, each on its own machine, run Memgraph as\nyou usually would."),(0,r.kt)("p",null,"If you are exploring replication and running multiple instances on one machine,\nplease install Memgraph with Docker, and run the following ",(0,r.kt)("inlineCode",{parentName:"p"},"docker run"),"\ncommands:"),(0,r.kt)("p",null,"The MAIN instance:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"docker run -it -p 7687:7687 -p 3000:3000 -p 7444:7444 -v mg_lib:/var/lib/memgraph memgraph/memgraph-platform\n")),(0,r.kt)("p",null,"REPLICA instance 1:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"docker run -it -p 7688:7687 -p 3001:3000 -p 7445:7444 -v mg_lib2:/var/lib/memgraph memgraph/memgraph-platform\n")),(0,r.kt)("p",null,"REPLICA instance 2:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"docker run -it -p 7689:7687 -p 3002:3000 -p 7446:7444 -v mg_lib3:/var/lib/memgraph memgraph/memgraph-platform\n")),(0,r.kt)("p",null,"REPLICA instance 3:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"docker run -it -p 7690:7687 -p 3003:3000 -p 7447:7444 -v mg_lib4:/var/lib/memgraph memgraph/memgraph-platform\n")),(0,r.kt)("p",null,"You can connect to each instance with the ",(0,r.kt)("a",{parentName:"p",href:"/memgraph-lab"},"Memgraph Lab"),"\nin-browser application at:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"the MAIN instance - ",(0,r.kt)("inlineCode",{parentName:"li"},"localhost:3000")),(0,r.kt)("li",{parentName:"ul"},"REPLICA instance 1 - ",(0,r.kt)("inlineCode",{parentName:"li"},"localhost:3001")),(0,r.kt)("li",{parentName:"ul"},"REPLICA instance 2 - ",(0,r.kt)("inlineCode",{parentName:"li"},"localhost:3002")),(0,r.kt)("li",{parentName:"ul"},"REPLICA instance 3 - ",(0,r.kt)("inlineCode",{parentName:"li"},"localhost:3003"))),(0,r.kt)("h2",{id:"how-to-demote-an-instance-to-a-replica-role"},"How to demote an instance to a REPLICA role?"),(0,r.kt)("p",null,"Run the following query in each REPLICA instance to demote instances to the\nREPLICA role:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"SET REPLICATION ROLE TO REPLICA WITH PORT 10000;\n")),(0,r.kt)("p",null,"If you set the port of each REPLICA instance to ",(0,r.kt)("inlineCode",{parentName:"p"},"10000"),", it will be easier to\nregister replicas later on because the query for registering replicas uses port\n",(0,r.kt)("inlineCode",{parentName:"p"},"10000")," as the default one."),(0,r.kt)("p",null,"Otherwise, you can use any unassigned port between 1000 and 10000."),(0,r.kt)("h2",{id:"how-to-register-replica-instances"},"How to register REPLICA instances?"),(0,r.kt)("p",null,"To register a REPLICA instance, you need to find out the IP address of each\ninstance."),(0,r.kt)("p",null,"The IP addresses will probably be:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"the MAIN instance - ",(0,r.kt)("inlineCode",{parentName:"li"},"172.17.0.2")),(0,r.kt)("li",{parentName:"ul"},"REPLICA instance 1 - ",(0,r.kt)("inlineCode",{parentName:"li"},"172.17.0.3")),(0,r.kt)("li",{parentName:"ul"},"REPLICA instance 2 - ",(0,r.kt)("inlineCode",{parentName:"li"},"172.17.0.4")),(0,r.kt)("li",{parentName:"ul"},"REPLICA instance 3 - ",(0,r.kt)("inlineCode",{parentName:"li"},"172.17.0.5"))),(0,r.kt)("p",null,"If they are not, please change the IP addresses in the following queries to\nmatch the IP addresses on your cluster."),(0,r.kt)("p",null,"Then, run the following queries from the MAIN instance to register REPLICA\ninstances:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"REPLICA instance 1 at ",(0,r.kt)("inlineCode",{parentName:"p"},"172.17.0.3")),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},'REGISTER REPLICA REP1 SYNC TO "172.17.0.3";\n')),(0,r.kt)("p",{parentName:"li"},"REPLICA instance 1 is called REP 1, its replication mode is SYNC, and it is\nlocated at IP address ",(0,r.kt)("inlineCode",{parentName:"p"},"172.17.0.3.")," with port ",(0,r.kt)("inlineCode",{parentName:"p"},"10000"),"."),(0,r.kt)("p",{parentName:"li"},"When the REPLICA instance is running in SYNC mode, the MAIN instance will not\ncommit a transaction until all REPLICA instances running in the SYNC mode\nconfirm they have received the same transaction. SYNC mode prioritizes data\nconsistency but has no tolerance for any network failures."),(0,r.kt)("p",{parentName:"li"},"If you used any port other than ",(0,r.kt)("inlineCode",{parentName:"p"},"10000"),' while demoting a REPLICA instance,\nyou will need to specify it like this: "172.17.0.3:5000"')),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"REPLICA instance 2 at ",(0,r.kt)("inlineCode",{parentName:"p"},"172.17.0.4")),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},'REGISTER REPLICA REP2 SYNC WITH TIMEOUT 1 TO "172.17.0.4";\n')),(0,r.kt)("p",{parentName:"li"},"REPLICA instance 2 is called REP 2, its replication mode is SYNC WITH\nTIMEOUT, and it is located at IP address ",(0,r.kt)("inlineCode",{parentName:"p"},"172.17.0.4.")," with port ",(0,r.kt)("inlineCode",{parentName:"p"},"10000"),"."),(0,r.kt)("p",{parentName:"li"},"When the REPLICA instance is running in SYNC WITH TIMEOUT mode the MAIN\ninstance will not commit a transaction until all REPLICA instances confirm\nthey have received the same transaction within a configured time interval. If\nthe response from a REPLICA times out, the replication mode of that instance\nwill be changed to ASYNC. SYNC WITH TIMEOUT prioritizes data consistency\nuntil unexpected issues force the system to prioritize availability and\npartition tolerance."),(0,r.kt)("p",{parentName:"li"},"If you used any port other than ",(0,r.kt)("inlineCode",{parentName:"p"},"10000"),' while demoting a REPLICA instance,\nyou will need to specify it like this: "172.17.0.3:5000"')),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"REPLICA instance 3 at ",(0,r.kt)("inlineCode",{parentName:"p"},"172.17.0.5")),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},'REGISTER REPLICA REP3 ASYNC TO "172.17.0.5";\n')),(0,r.kt)("p",{parentName:"li"},"REPLICA instance 3 is called REP 3, its replication mode is ASYNC, and it is\nlocated at IP address ",(0,r.kt)("inlineCode",{parentName:"p"},"172.17.0.5.")," with port ",(0,r.kt)("inlineCode",{parentName:"p"},"10000"),"."),(0,r.kt)("p",{parentName:"li"},"When the REPLICA instance is running in ASYNC mode the MAIN instance will\ncommit a transaction without receiving confirmation from REPLICA instances\nthat they have received the same transaction. ASYNC mode ensures system\navailability and partition tolerance."),(0,r.kt)("p",{parentName:"li"},"If you used any port other than ",(0,r.kt)("inlineCode",{parentName:"p"},"10000"),' while demoting a REPLICA instance,\nyou will need to specify it like this: "172.17.0.3:5000"'))),(0,r.kt)("h2",{id:"how-to-check-info-about-registered-replica-instances"},"How to check info about registered REPLICA instances?"),(0,r.kt)("p",null,"Check all the REPLICA instances by running the following query from the MAIN\ninstance:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"SHOW REPLICAS;\n")),(0,r.kt)("h2",{id:"how-to-drop-a-replica-instance"},"How to drop a REPLICA instance?"),(0,r.kt)("p",null,"To drop a replica, run the following query:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-plaintext"},"DROP REPLICA <name>;\n")),(0,r.kt)("h2",{id:"how-to-promote-a-replica-instance-to-main"},"How to promote a REPLICA instance to MAIN?"),(0,r.kt)("p",null,"To promote a REPLICA instance to MAIN, run the following query:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-plaintext"},"SET REPLICATION ROLE TO MAIN;\n")))}d.isMDXComponent=!0}}]);